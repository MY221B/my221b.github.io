<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机餐厅选择器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* 保留原有的样式 */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        select, button, input[type="file"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        #clearHistory, #uploadLink {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 5px 10px;
            font-size: 14px;
            margin-top: 10px;
            cursor: pointer;
        }
        #clearHistory:hover, #uploadLink:hover {
            background-color: #e0e0e0;
        }
        #uploadLink {
            display: inline-block;
            text-decoration: none;
        }
        #csvFile {
            display: none;
        }
        /* 新增样式 */
        #locationInput {
            display: flex;
            margin-bottom: 15px;
        }
        #locationInput input {
            flex-grow: 1;
            margin-right: 10px;
        }
        #locationInput button {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>随机餐厅选择器</h1>
        <div id="locationInput">
            <input type="text" id="addressInput" placeholder="输入您的位置（例如：北京市朝阳区）">
            <button id="searchLocation">搜索位置</button>
        </div>
        <div class="form-group">
            <label for="citySelect">选择城市：</label>
            <select id="citySelect">
                <option value="all">所有城市</option>
            </select>
        </div>
        <div id="restaurantCount"></div>
        <button id="randomSelect">随机选择餐厅</button>
        <div id="result"></div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>名称</th>
                    <th>地址</th>
                    <th>城市</th>
                    <th>电话</th>
                    <th>已收藏天数</th>
                    <th>链接</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button id="clearHistory">清除历史记录</button>
        <a href="#" id="uploadLink">上传自定义餐厅数据</a>
        <input type="file" id="csvFile" accept=".csv">
    </div>

    <script>
        let restaurants = [];
        let userPosition;

        const API_KEY = 'd111bbe935342b4ac8d1707ff6523552'; // 请替换为您的实际 API key

        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultCSV();
            requestUserLocation();
        });

        function loadDefaultCSV() {
            fetch('https://raw.githubusercontent.com/你的GitHub用户名/你的仓库名/main/restaurants.csv')
                .then(response => response.text())
                .then(csvData => {
                    processCSVData(csvData);
                })
                .catch(error => console.error('Error loading default CSV file:', error));
        }

        function processCSVData(csvData) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    restaurants = results.data
                        .filter(row => row['名称'] && row['名称'].trim() !== '')
                        .map(row => ({
                            name: row['名称'] || '未提供',
                            url: convertToMobileUrl(row['J_shopt href']) || '#',
                            address: row['地址'] || '未提供',
                            city: row['city'] ? row['city'].replace(/[\[\]]/g, '') : '未提供',
                            tel: row['tel'] || '未提供',
                            time: row['time'] || '未提供'
                        }));
                    updateCityList();
                    updateRestaurantCount();
                }
            });
        }

        function requestUserLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userPosition = {
                        lng: position.coords.longitude,
                        lat: position.coords.latitude
                    };
                    console.log('User position:', userPosition);
                }, function(error) {
                    console.error('Error getting user location:', error);
                    alert('无法自动获取您的位置。您可以手动输入位置。');
                });
            } else {
                console.log("Geolocation is not supported by this browser.");
                alert('您的浏览器不支持地理位置功能。您可以手动输入位置。');
            }
        }

        function searchLocation() {
            const address = document.getElementById('addressInput').value;
            if (!address) {
                alert('请输入位置');
                return;
            }

            const geocodeUrl = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&output=json&key=${API_KEY}`;
            
            fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location.split(',');
                        userPosition = {
                            lng: parseFloat(location[0]),
                            lat: parseFloat(location[1])
                        };
                        console.log('User position updated:', userPosition);
                        alert('位置已更新');
                    } else {
                        alert('无法找到该位置，请尝试更详细的地址');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('位置搜索失败，请稍后重试');
                });
        }

        function selectRandomRestaurant() {
            const selectedCity = document.getElementById('citySelect').value;
            const filteredRestaurants = selectedCity === 'all'
                ? restaurants
                : restaurants.filter(r => r.city === selectedCity);

            if (filteredRestaurants.length === 0) {
                document.getElementById('result').innerHTML = '没有找到符合条件的餐厅';
                return;
            }

            const randomRestaurant = filteredRestaurants[Math.floor(Math.random() * filteredRestaurants.length)];
            displayRestaurantInfo(randomRestaurant);
            addToHistory(randomRestaurant);
            
            if (userPosition) {
                getRestaurantLocationAndCalculateDistance(randomRestaurant);
            } else {
                document.getElementById('distance-info').textContent = '无法计算距离：用户位置未知。请手动输入位置。';
            }
        }

        function displayRestaurantInfo(restaurant) {
            const resultDiv = document.getElementById('result');
            const daysSinceFavorited = calculateDaysSinceFavorited(restaurant.time);
            resultDiv.innerHTML = `
                <h2>${restaurant.name}</h2>
                <p>地址：${restaurant.address}</p>
                <p>城市：${restaurant.city}</p>
                <p>电话：${restaurant.tel}</p>
                <p>已收藏 ${daysSinceFavorited} 天</p>
                <p><a href="${restaurant.url}" target="_blank">在大众点评查看更多信息</a></p>
                <p id="distance-info">计算距离中...</p>
            `;
        }

        function getRestaurantLocationAndCalculateDistance(restaurant) {
            const address = `${restaurant.city}${restaurant.address}`;
            const geocodeUrl = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&output=json&key=${API_KEY}`;
            
            fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location;
                        calculateDistance(userPosition, location.split(','));
                    } else {
                        document.getElementById('distance-info').textContent = '无法计算距离：地址无法解析';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('distance-info').textContent = '地理编码请求失败';
                });
        }

        function calculateDistance(origin, destination) {
            const drivingUrl = `https://restapi.amap.com/v5/direction/driving?origin=${origin.lng},${origin.lat}&destination=${destination[0]},${destination[1]}&key=${API_KEY}`;
            
            fetch(drivingUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.route && data.route.paths.length > 0) {
                        const route = data.route.paths[0];
                        updateDistanceInfo(route.distance, route.duration);
                    } else {
                        document.getElementById('distance-info').textContent = '无法计算路线';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('distance-info').textContent = '路线计算请求失败';
                });
        }

        function updateDistanceInfo(distance, duration) {
            const distanceInfo = document.getElementById('distance-info');
            distanceInfo.textContent = `距离：${(distance / 1000).toFixed(2)} 公里，预计驾车时间：${Math.round(duration / 60)} 分钟`;
        }

        function updateCityList() {
            const cities = [...new Set(restaurants.map(r => r.city))];
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="all">所有城市</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }

        function updateRestaurantCount() {
            const selectedCity = document.getElementById('citySelect').value;
            const count = selectedCity === 'all'
                ? restaurants.length
                : restaurants.filter(r => r.city === selectedCity).length;
            document.getElementById('restaurantCount').textContent = `当前选择中有 ${count} 家餐厅`;
        }

        function calculateDaysSinceFavorited(favoriteDate) {
            const today = new Date();
            const favoriteDateObj = new Date(favoriteDate);
            const diffTime = Math.abs(today - favoriteDateObj);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function addToHistory(restaurant) {
            const historyTable = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
            const row = historyTable.insertRow(0);
            const daysSinceFavorited = calculateDaysSinceFavorited(restaurant.time);
            row.innerHTML = `
                <td>${restaurant.name}</td>
                <td>${restaurant.address}</td>
                <td>${restaurant.city}</td>
                <td>${restaurant.tel}</td>
                <td>${daysSinceFavorited} 天</td>
                <td><a href="${restaurant.url}" target="_blank">查看</a></td>
            `;
        }

        function clearHistory() {
            const historyTable = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
            historyTable.innerHTML = '';
        }

        function convertToMobileUrl(url) {
            if (!url) return '#';
            return url.replace('https://www.dianping.com/shop/', 'https://m.dianping.com/shopshare/');
        }

        document.getElementById('citySelect').addEventListener('change', updateRestaurantCount);
        document.getElementById('randomSelect').addEventListener('click', selectRandomRestaurant);
        document.getElementById('clearHistory').addEventListener('click', clearHistory);
        document.getElementById('uploadLink').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('csvFile').click();
        });
        document.getElementById('csvFile').addEventListener('change', handleFileSelect);
        document.getElementById('searchLocation').addEventListener('click', searchLocation);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload =