<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机餐厅选择器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        select, button, input[type="file"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        #clearHistory, #uploadLink {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 5px 10px;
            font-size: 14px;
            margin-top: 10px;
            cursor: pointer;
        }
        #clearHistory:hover, #uploadLink:hover {
            background-color: #e0e0e0;
        }
        #uploadLink {
            display: inline-block;
            text-decoration: none;
        }
        #csvFile {
            display: none;
        }
        /* 新增样式 */
        #locationInput {
            display: flex;
            margin-bottom: 15px;
        }
        #locationInput input {
            flex-grow: 1;
            margin-right: 10px;
        }
        #locationInput button {
            width: auto;
        }
        #searchLocation {
            width: 150px; /* 设置一个固定宽度 */
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #searchLocation:hover {
            background-color: #45a049;
        }
        .truncate {
            max-width: 150px; /* 调整宽度以适应您的布局 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>随机餐厅选择器</h1>
        <div id="locationInput">
            <input type="text" id="addressInput" placeholder="输入您的城市和位置（例如：北京悦来大厦）">
            <button id="searchLocation">搜索位置</button>
        </div>
        <div class="form-group">
            <label for="citySelect">选择城市：</label>
            <select id="citySelect">
                <option value="all">所有城市</option>
            </select>
        </div>
        <div id="timeFilterContainer"></div>  <!-- 新添加的时间筛选器容器 -->
        <div id="restaurantCount"></div>
        <button id="randomSelect">随机选择餐厅</button>
        <div id="result"></div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>名称</th>
                    <th>地址</th>
                    <th>距离</th>
                    <th>时间</th>
                    <th>收藏</th>
                    <th>链接</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button id="clearHistory">清除历史记录</button>
        <a href="#" id="uploadLink">上传自定义餐厅数据</a>
        <input type="file" id="csvFile" accept=".csv">
    </div>

    <script>
        let restaurants = [];
        let userPosition;

        const API_KEY = 'd111bbe935342b4ac8d1707ff6523552'; // 请替换为您的实际 API key

        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultCSV();
            requestUserLocation();
        });

        ///// 初始化和数据加载、处理相关的函数 ///// 
        // 加载默认的CSV文件，包含餐厅数据
        function loadDefaultCSV() {
            fetch('https://raw.githubusercontent.com/MY221B/my221b.github.io/main/restaurants_with_distances.csv')
                .then(response => response.text())
                .then(csvData => {
                    processCSVData(csvData);
                })
                .catch(error => console.error('Error loading default CSV file:', error));
        }
        
        // 处理CSV数据，将其转换为可用的餐厅对象数组，并提取保存的位置
        function processCSVData(csvData) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    restaurants = results.data
                        .filter(row => row['名称'] && row['名称'].trim() !== '')
                        .map(row => ({
                            name: row['名称'] || '未提供',
                            url: convertToMobileUrl(row['J_shopt href']) || '#',
                            address: row['地址'] || '未提供',
                            city: row['city'] ? row['city'].replace(/[\[\]]/g, '') : '未提供',
                            tel: row['tel'] || '未提供',
                            time: row['time'] || '未提供',
                            ...row  // 保留所有原始数据，包括距离和时间列
                        }));
                    extractSavedLocations(restaurants);  // 提取保存的位置
                    updateCityList();
                    updateRestaurantCount();
                }
            });
        }

        let savedLocations = [];

        // 从餐厅数据中提取保存的位置信息
        function extractSavedLocations(restaurants) {
            const locationSet = new Set();
            restaurants.forEach(restaurant => {
                Object.keys(restaurant).forEach(key => {
                    if (key.endsWith('距离')) {
                        const location = key.replace('距离', '');
                        locationSet.add(location);
                    }
                });
            });
            savedLocations = Array.from(locationSet);
            console.log('Saved locations:', savedLocations);
        }


        ///// 用户交互、UI更新相关的函数 ///// 
        // 请求用户的地理位置
        function requestUserLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userPosition = {
                        lng: position.coords.longitude,
                        lat: position.coords.latitude
                    };
                    console.log('User position:', userPosition);
                    
                    reverseGeocode(userPosition.lng, userPosition.lat)
                        .then(city => {
                            console.log('User city:', city);
                            updateCitySelect(city);
                            calculateNearestLocation(userPosition);
                            document.getElementById('addressInput').placeholder = "已成功获取当前地址";
                        })
                        .catch(error => {
                            console.error('Error in reverse geocoding:', error);
                            alert('无法获取城市信息，请手动选择城市。');
                        });
                }, function(error) {
                    console.error('Error getting user location:', error);
                    alert('无法自动获取您的位置。您可以手动输入位置。');
                });
            } else {
                console.log("Geolocation is not supported by this browser.");
                alert('您的浏览器不支持地理位置功能。您可以手动输入位置。');
            }
        }

        // 搜索用户输入的位置
        function searchLocation() {
            const address = document.getElementById('addressInput').value;
            if (!address) {
                alert('请输入位置');
                return;
            }

            const geocodeUrl = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&output=json&key=${API_KEY}`;
            
            fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes.length > 0) {
                        const geocode = data.geocodes[0];
                        const location = geocode.location.split(',');
                        userPosition = {
                            lng: parseFloat(location[0]),
                            lat: parseFloat(location[1])
                        };
                        console.log('User position updated:', userPosition);
                        document.getElementById('addressInput').placeholder = "已成功获取当前地址";
                        
                        // 获取城市信息并更新城市选择器
                        const city = geocode.city;
                        console.log('User city:', city);
                        updateCitySelect(city);
                        
                        alert('位置已更新');
                        calculateNearestLocation(userPosition);  // 计算最近位置
                    } else {
                        alert('无法找到该位置，请尝试更详细的地址');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('位置搜索失败，请稍后重试');
                });
        }

        // 处理用户上传的CSV文件
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processCSVData(e.target.result);
                };
                reader.readAsText(file);
            }
        }

        // 更新城市列表下拉菜单
        function updateCityList() {
            const cities = [...new Set(restaurants.map(r => r.city))];
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="all">所有城市</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city; // 保持原有格式
                option.textContent = city; // 保持原有格式
                citySelect.appendChild(option);
            });
        }

        // 更新城市选择器的选中项
        function updateCitySelect(city) {
            const citySelect = document.getElementById('citySelect');
            const normalizedCity = city.endsWith('市') ? city : city + '市';
            
            const cityOption = Array.from(citySelect.options).find(option => {
                const optionCity = option.value.replace(/^\[|\]$/g, ''); // 移除开头的 [ 和结尾的 ]
                return optionCity === normalizedCity || optionCity + '市' === normalizedCity || optionCity === city;
            });
            
            if (cityOption) {
                citySelect.value = cityOption.value;
                console.log(`City "${city}" matched with option "${cityOption.text}"`);
            } else {
                console.log(`City "${city}" not found in options, keeping current selection.`);
            }
            
            // 触发 change 事件以更新餐厅计数
            citySelect.dispatchEvent(new Event('change'));
        }

        // 更新显示当前选择中的餐厅数量
        function updateRestaurantCount() {
            const selectedCity = document.getElementById('citySelect').value;
            const maxTime = document.getElementById('timeFilter') ? parseInt(document.getElementById('timeFilter').value) : Infinity;

            const count = restaurants.filter(r => {
                const cityMatch = selectedCity === 'all' || r.city === selectedCity;
                const timeMatch = minDrivingTime > 10 || parseInt(r[`${nearestLocation}时间`]) <= maxTime;
                return cityMatch && timeMatch;
            }).length;

            document.getElementById('restaurantCount').textContent = `当前选择中有 ${count} 家餐厅`;
        }

        // 更新时间筛选器的UI
        // 在时间筛选器的 input 事件监听器中调用 updateRestaurantCount
        function updateTimeFilterUI() {
            const filterContainer = document.getElementById('timeFilterContainer');
            if (minDrivingTime <= 10) {
                filterContainer.style.display = 'block';
                filterContainer.innerHTML = `
                    <label for="timeFilter">选择最大行驶时间（分钟）：</label>
                    <input type="range" id="timeFilter" min="0" max="120" step="5" value="30">
                    <span id="timeFilterValue">30</span>
                `;
                document.getElementById('timeFilter').addEventListener('input', function() {
                    document.getElementById('timeFilterValue').textContent = this.value;
                    updateRestaurantCount();  // 添加这行
                });
            } else {
                filterContainer.style.display = 'none';
            }
            updateRestaurantCount();  // 确保在UI更新后立即更新计数
        }

        // 随机选择一家符合条件的餐厅
        function selectRandomRestaurant() {
            const selectedCity = document.getElementById('citySelect').value;
            const maxTime = document.getElementById('timeFilter') ? parseInt(document.getElementById('timeFilter').value) : Infinity;

            const filteredRestaurants = restaurants.filter(r => {
                const cityMatch = selectedCity === 'all' || r.city === selectedCity;
                const timeMatch = minDrivingTime > 10 || parseInt(r[`${nearestLocation}时间`]) <= maxTime;
                return cityMatch && timeMatch;
            });

            if (filteredRestaurants.length === 0) {
                document.getElementById('result').innerHTML = '没有找到符合条件的餐厅';
                return;
            }

            const randomRestaurant = filteredRestaurants[Math.floor(Math.random() * filteredRestaurants.length)];
            displayRestaurantInfo(randomRestaurant);
            
            if (userPosition) {
                console.log('Calculating distance for restaurant:', randomRestaurant.name);
                getRestaurantLocationAndCalculateDistance(randomRestaurant);
            } else {
                console.log('User position not available, cannot calculate distance');
                document.getElementById('distance-info').textContent = '无法计算距离：用户位置未知。请手动输入位置。';
                addToHistory(randomRestaurant, null, null);
            }
        }

        // 显示选中餐厅的详细信息
        function displayRestaurantInfo(restaurant) {
            const resultDiv = document.getElementById('result');
            const daysSinceFavorited = calculateDaysSinceFavorited(restaurant.time);
            resultDiv.innerHTML = `
                <h2>${restaurant.name}</h2>
                <p>地址：${restaurant.address}</p>
                <p>城市：${restaurant.city}</p>
                <p>电话：${restaurant.tel}</p>
                <p>已收藏 ${daysSinceFavorited} 天</p>
                <p><a href="${restaurant.url}" target="_blank">在大众点评查看更多信息</a></p>
                <p id="distance-info">计算距离中...</p>
            `;
        }
        

        // 更新距离信息显示
        function updateDistanceInfo(distance, duration, taxiCost) {
            console.log('Updating distance info:', distance, 'meters,', duration, 'seconds, taxi cost:', taxiCost);
            const distanceInfo = document.getElementById('distance-info');
            distanceInfo.innerHTML = `
                <p>距离：${(distance / 1000).toFixed(2)} 公里</p>
                <p>预计驾车时间：${Math.round(duration / 60)} 分钟</p>
                <p>预估出租车费用：${taxiCost} 元</p>
            `;
        }

        // 将选中的餐厅添加到历史记录中
        function addToHistory(restaurant, distance, duration) {
            const historyTable = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
            const row = historyTable.insertRow(0);
            const daysSinceFavorited = calculateDaysSinceFavorited(restaurant.time);
            
            const truncatedAddress = truncateString(restaurant.address, 10);

            row.innerHTML = `
                <td>${restaurant.name}</td>
                <td class="truncate" title="${restaurant.address}">${truncatedAddress}</td>
                <td>${distance ? Math.round(distance / 1000): 'N/A'} km</td>
                <td>${duration ? Math.round(duration / 60) : 'N/A'} 分钟</td>
                <td>${daysSinceFavorited} 天</td>
                <td><a href="${restaurant.url}" target="_blank">查看</a></td>
            `;
        }

        // 清除历史记录
        function clearHistory() {
            const historyTable = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
            historyTable.innerHTML = '';
        }

         ///// 位置和地理编码相关的函数 ///// 
        // 使用高德地图API进行逆地理编码，将经纬度转换为城市名称
        function reverseGeocode(lng, lat) {
            const url = `https://restapi.amap.com/v3/geocode/regeo?key=${API_KEY}&location=${lng},${lat}&extensions=base`;
            
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "1" && data.regeocode) {
                        const addressComponent = data.regeocode.addressComponent;
                        let city = addressComponent.city;
                        
                        // 如果city为空，使用province
                        if (!city || city.length === 0) {
                            city = addressComponent.province;
                        }
                        
                        // 如果city是数组，取第一个元素
                        if (Array.isArray(city)) {
                            city = city[0];
                        }
                        
                        return city;
                    } else {
                        throw new Error('Unable to reverse geocode');
                    }
                });
        }

        // 获取餐厅位置并计算与用户的距离，获得餐厅的经纬度，调用 calculateDistance 计算距离
        function getRestaurantLocationAndCalculateDistance(restaurant) {
            const address = `${restaurant.city}${restaurant.address}`;
            console.log('Getting location for restaurant address:', address);
            const geocodeUrl = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&output=json&key=${API_KEY}`;
            
            console.log('Sending geocode request for restaurant:', geocodeUrl);
            fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Geocode response for restaurant:', data);
                    if (data.status === '1' && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location;
                        console.log('Restaurant location obtained:', location);
                        calculateDistance(userPosition, location.split(','), restaurant);
                    } else {
                        console.log('Unable to geocode restaurant address');
                        document.getElementById('distance-info').textContent = '无法计算距离：地址无法解析';
                        addToHistory(restaurant, null, null);
                    }
                })
                .catch(error => {
                    console.error('Error in geocode request for restaurant:', error);
                    document.getElementById('distance-info').textContent = '地理编码请求失败';
                    addToHistory(restaurant, null, null);
                });
        }

        // 计算用户位置到餐厅的距离，调用其他函数来更新UI
        function calculateDistance(origin, destination, restaurant) {
            console.log('Calculating distance from', origin, 'to', destination);
            const drivingUrl = `https://restapi.amap.com/v3/direction/driving?origin=${origin.lng},${origin.lat}&destination=${destination[0]},${destination[1]}&extensions=all&strategy=10&key=${API_KEY}`;
            
            console.log('Sending driving route request:', drivingUrl);
            fetch(drivingUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Driving route response:', data);
                    if (data.status === '1' && data.route && data.route.paths && data.route.paths.length > 0) {
                        const route = data.route.paths[0];
                        const taxiCost = data.route.taxi_cost;
                        console.log('Route found, distance:', route.distance, 'duration:', route.duration, 'taxi cost:', taxiCost);
                        
                        const distance = parseFloat(route.distance);
                        const duration = parseFloat(route.duration);
                        const cost = parseFloat(taxiCost);

                        if (!isNaN(distance) && !isNaN(duration) && !isNaN(cost)) {
                            updateDistanceInfo(distance, duration, cost);
                            addToHistory(restaurant, distance, duration);
                        } else {
                            console.error('Invalid data received:', { distance, duration, taxiCost });
                            document.getElementById('distance-info').textContent = '收到的数据无效，无法计算路线信息';
                            addToHistory(restaurant, null, null);
                        }
                    } else {
                        console.log('Unable to calculate route');
                        document.getElementById('distance-info').textContent = '无法计算路线';
                        addToHistory(restaurant, null, null);
                    }
                })
                .catch(error => {
                    console.error('Error in driving route request:', error);
                    document.getElementById('distance-info').textContent = '路线计算请求失败';
                    addToHistory(restaurant, null, null);
                });
        }

        let nearestLocation = null;
        let minDrivingTime = Infinity;

        // 计算用户位置到所有保存位置的距离，找出最近的位置
        function calculateNearestLocation(userPosition) {
            console.log('Calculating nearest location for user position:', userPosition);
            nearestLocation = null;
            minDrivingTime = Infinity;

            const promises = savedLocations.map(location => {
                const geocodeUrl = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(location)}&output=json&key=${API_KEY}`;
                return fetch(geocodeUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === '1' && data.geocodes.length > 0) {
                            const [lng, lat] = data.geocodes[0].location.split(',');
                            const drivingUrl = `https://restapi.amap.com/v3/direction/driving?origin=${userPosition.lng},${userPosition.lat}&destination=${lng},${lat}&extensions=base&key=${API_KEY}`;
                            return fetch(drivingUrl)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === '1' && data.route && data.route.paths && data.route.paths.length > 0) {
                                        const drivingTime = parseInt(data.route.paths[0].duration) / 60;  // 转换为分钟
                                        console.log(`Driving time to ${location}: ${drivingTime} minutes`);
                                        return { location, drivingTime };
                                    }
                                    console.log(`Unable to calculate driving time to ${location}`);
                                    return null;
                                });
                        }
                        console.log(`Unable to geocode location: ${location}`);
                        return null;
                    });
            });

            Promise.all(promises)
                .then(results => {
                    results.forEach(result => {
                        if (result && result.drivingTime < minDrivingTime) {
                            minDrivingTime = result.drivingTime;
                            nearestLocation = result.location;
                        }
                    });
                    console.log(`Nearest location: ${nearestLocation}, Driving time: ${minDrivingTime} minutes`);
                    updateTimeFilterUI();
                    updateRestaurantCount();  // 确保在计算完成后更新餐厅计数
                });
        }

        ///// 辅助功能函数 ///// 
        // 计算收藏餐厅至今的天数
        function calculateDaysSinceFavorited(favoriteDate) {
            const today = new Date();
            const favoriteDateObj = new Date(favoriteDate);
            const diffTime = Math.abs(today - favoriteDateObj);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // 截断字符串，使其不超过指定长度
        function truncateString(str, num) {
            if (str.length <= num) {
                return str;
            }
            return str.slice(0, num) + '...';
        }

        // 将URL转换为移动端友好的格式
        function convertToMobileUrl(url) {
            if (!url) return '#';
            return url.replace('https://www.dianping.com/shop/', 'https://m.dianping.com/shopshare/');
        }

        document.getElementById('citySelect').addEventListener('change', updateRestaurantCount);
        document.getElementById('randomSelect').addEventListener('click', selectRandomRestaurant);
        document.getElementById('clearHistory').addEventListener('click', clearHistory);
        document.getElementById('uploadLink').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('csvFile').click();
        });
        document.getElementById('csvFile').addEventListener('change', handleFileSelect);
        document.getElementById('searchLocation').addEventListener('click', searchLocation);
        
    </script>
</body>
</html>
